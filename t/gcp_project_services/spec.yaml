# Copyright 2023 The Authors (see AUTHORS file)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: 'cli.abcxyz.dev/v1alpha1'
kind: 'Template'

desc: |
  'Enables Cloud Run and associated services for a resource project in a given environment.'
  Usage:
    $ abc templates render \
    -input="product_id=abc-demo" \
    -input="project_id=abc-demo-a-6a5eab" \
    -input="services=artifactregistry.googleapis.com,iam.googleapis.com,run.googleapis.com" \
    -input="environment=integration" \
    -input="bucket_name=abcxyz-tycho-terraform-state-f916" \
    -input="bucket_prefix=infra" \
    -dest="./resources/abc-demo" \
    -spec="spec.yaml" \
    ~/gitrepos/abc/t/gcp_project_services

inputs:
  - name: 'product_id'
    desc: 'The id of the product to create'

  - name: 'project_id'
    desc: 'The id of the project to enable services on'

  - name: 'services'
    desc: 'A list of services to enable for each project'

  - name: 'environment'
    desc: 'The environment to enable services on'

  - name: 'bucket_name'
    desc: 'The Google Clod storage bucket name for the Terraform state'

  - name: 'bucket_prefix'
    desc: 'The Terraform state bucket prefix'

steps:
  - desc: 'Include some files and directories'
    action: 'include'
    params:
      paths:
        - 'environment-main.tf'
        - 'environment-terraform.tf'
        - 'environment-terraform.backend.tf'
      as:
        - '{{.environment}}/main.tf'
        - '{{.environment}}/terraform.tf'
        - '{{.environment}}/terraform.backend.tf'

  - desc: 'Render template with input variables'
    action: 'go_template'
    params:
      paths:
        - '{{.environment}}/main.tf'
        - '{{.environment}}/terraform.backend.tf'
